"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("../../../utils/util");
var app = getApp();
Page({
    data: {
        isImport: false,
        isUpdate: false,
        questionList: [{
                question: "",
                answer: "",
                desc: "",
            }],
        title: "",
        desc: "",
        memoryObjStr: "",
    },
    setState: (function () { return 0; }),
    onLoad: function (options) {
        var _this = this;
        var sd = this.setData;
        this.setState = sd;
        this.setData = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            _this.saveTempMemory();
            console.log("setData...");
            sd.apply(_this, args);
        };
        var type = options.type;
        if (type !== "update") {
            this.getTempMemory();
            return;
        }
        wx.setNavigationBarTitle({ title: "编辑" });
        var memory = wx.getStorageSync("memory") || [];
        var index = app.globalData.currentMemoryIndex;
        var _a = memory[index], questionList = _a.questionList, title = _a.title;
        if (questionList.length > 5) {
            this.splitPushToData(questionList.slice(5));
            questionList = questionList.splice(0, 5);
        }
        sd.call(this, { isUpdate: true, title: title, questionList: questionList });
    },
    saveTempMemory: (function () {
        function save() {
            console.log("缓存表单...");
            var title = this.data.title;
            var questionList = this.data.questionList;
            wx.setStorage({ key: "tempMemory", data: { title: title, questionList: questionList } });
        }
        return util_1.debounce(save, 600);
    })(),
    splitPushToData: function (tempQL) {
        var _this = this;
        var timer = setInterval(function () {
            var questionList = _this.data.questionList;
            Array.prototype.push.apply(questionList, tempQL.splice(0, 10));
            _this.setState({ questionList: questionList });
            if (!tempQL.length) {
                clearInterval(timer);
            }
        }, 100);
    },
    getTempMemory: function () {
        try {
            var temp = wx.getStorageSync("tempMemory");
            if (!temp || !temp.title)
                return;
            var title = temp.title, questionList = temp.questionList;
            if (questionList.length > 5) {
                this.splitPushToData(questionList.slice(5));
                questionList = questionList.splice(0, 5);
            }
            this.setState({ title: title, questionList: questionList });
        }
        catch (e) {
            console.log("getTempMemory error", e);
        }
    },
    bindKeyInput: function (e) {
        var _a, _b;
        var detail = e.detail, target = e.target;
        var value = detail.value;
        var _c = target.dataset, index = _c.index, type = _c.type;
        if (/item\.(\w+)/.test(type)) {
            var obj = this.data.questionList[index];
            obj[RegExp.$1] = value;
            this.setData((_a = {},
                _a["questionList[" + index + "]"] = obj,
                _a));
        }
        else {
            this.setData((_b = {}, _b[type] = value, _b));
        }
    },
    validate: function (title, questionList) {
        if (!title) {
            wx.showToast({ icon: "none", title: "标题不能为空!", duration: 3000 });
            return false;
        }
        for (var i = 0; i < questionList.length; i++) {
            var item = questionList[i];
            if (!item.question) {
                wx.showToast({ icon: "none", title: "\u95EE\u9898" + (i + 1) + "\u4E0D\u80FD\u4E3A\u7A7A!", duration: 3000 });
                return false;
            }
            if (!item.answer) {
                wx.showToast({ icon: "none", title: "\u7B54\u6848" + (i + 1) + "\u4E0D\u80FD\u4E3A\u7A7A!", duration: 3000 });
                return false;
            }
        }
        return true;
    },
    formSubmit: function (e) {
        console.log('form发生了submit事件，携带数据为：', e.detail.value);
        var _a = this.data, title = _a.title, questionList = _a.questionList, isUpdate = _a.isUpdate;
        if (!this.validate(title, questionList))
            return;
        try {
            var key = "memory";
            var memory = wx.getStorageSync(key) || [];
            var obj = { title: title, questionList: questionList };
            if (isUpdate) {
                memory[app.globalData.currentMemoryIndex] = obj;
            }
            else {
                memory.push(obj);
            }
            wx.setStorageSync(key, memory);
            wx.showToast({ icon: "success", title: (isUpdate ? "修改" : "保存") + "\u6210\u529F" });
            setTimeout(function () {
                wx.navigateBack();
                wx.setStorageSync("tempMemory", null);
            }, 1500);
        }
        catch (e) {
        }
    },
    formReset: function (e) {
        console.log('form发生了reset事件，携带数据为：', e.detail.value);
        var questionList = [{
                question: "",
                answer: "",
                desc: "",
            }];
        var title = "";
        if (this.data.isImport) {
            this.setData({
                memoryObjStr: JSON.stringify({ title: title, questionList: questionList }),
            });
        }
        else {
            this.setData({
                questionList: questionList,
                title: title,
            });
        }
    },
    questionListAdd: function () {
        var ml = this.data.questionList;
        ml.push({
            question: "",
            answer: "",
            desc: "",
        });
        this.setData({
            questionList: ml,
        });
    },
    questionListDelete: function (e) {
        var index = e.target.dataset.index;
        console.log(index);
        var ml = this.data.questionList;
        ml.splice(index, 1);
        this.setData({
            questionList: ml,
        });
    },
    memoryImport: function () {
        var _a = this.data, title = _a.title, questionList = _a.questionList;
        this.setData({ isImport: true, memoryObjStr: JSON.stringify({ title: title, questionList: questionList }) });
    },
    memoryExport: function () {
        var _a = this.data, title = _a.title, questionList = _a.questionList;
        var fsm = wx.getFileSystemManager();
        var filePath = wx.env.USER_DATA_PATH + "/" + title + ".json";
        fsm.writeFile({
            filePath: filePath,
            data: JSON.stringify({ title: title, questionList: questionList }),
            encoding: "utf-8",
            success: function () {
                wx.showToast({ icon: "none", title: "保存成功" });
                wx.openDocument({ filePath: filePath });
            },
            fail: function (res) {
                console.log(res);
                wx.showToast({ icon: "none", title: "保存失败" });
            },
        });
    },
    back: function () {
        this.setData({ isImport: false });
    },
    confirm: function () {
        var memoryObjStr = this.data.memoryObjStr;
        try {
            var obj = JSON.parse(memoryObjStr);
            if (this.validate(obj.title, obj.questionList)) {
                if (obj.questionList.length > 5) {
                    this.splitPushToData(obj.questionList.slice(5));
                    obj.questionList = obj.questionList.splice(0, 5);
                }
                this.setData(__assign({ isImport: false }, obj));
            }
        }
        catch (e) {
            wx.showToast({ icon: "none", title: "1111111" });
        }
    },
    fileImport: function () {
        var _this = this;
        wx.chooseMessageFile({
            count: 1,
            type: "file",
            extension: ["json", "txt"],
            success: function (res) {
                console.log(res.tempFiles[0]);
                wx.getFileSystemManager().readFile({
                    filePath: res.tempFiles[0].path,
                    encoding: "utf-8",
                    success: function (e) {
                        var value = e.data;
                        console.log("读取到文件：");
                        console.log(value);
                        try {
                            var obj = JSON.parse(value);
                            if (!value || !_this.validate(obj.title, obj.questionList)) {
                                wx.showToast({ icon: "none", title: "文件格式不正确" });
                                return;
                            }
                            _this.setData({ memoryObjStr: value });
                        }
                        catch (e) {
                            wx.showToast({ icon: "none", title: "文件格式不对" });
                        }
                    },
                });
            },
        });
    },
    onInputEdit: function (e) {
        var value = e.detail.value;
        this.setState({ memoryObjStr: value });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSw0Q0FBdUU7QUFFdkUsSUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFjLENBQUM7QUFDakMsSUFBSSxDQUFDO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsUUFBUSxFQUFFLEtBQUs7UUFFZixRQUFRLEVBQUUsS0FBSztRQUNmLFlBQVksRUFBc0IsQ0FBQztnQkFDL0IsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLEVBQUU7YUFDWCxDQUFDO1FBQ0YsS0FBSyxFQUFFLEVBQUU7UUFDVCxJQUFJLEVBQUUsRUFBRTtRQUNSLFlBQVksRUFBRSxFQUFFO0tBQ25CO0lBRUQsUUFBUSxFQUFPLENBQUMsY0FBTSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUM7SUFDeEIsTUFBTSxFQUFFLFVBQVMsT0FBTztRQUFoQixpQkE4QlA7UUE3QkcsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQUMsY0FBYztpQkFBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJQUFjO2dCQUFkLHlCQUFjOztZQUMxQixLQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQixFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUksRUFBRSxJQUFXLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUM7UUFHRixJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBQzFCLElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNuQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDckIsT0FBTztTQUNWO1FBR0QsRUFB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Q0FBQzt5QkFDdkM7d0JBQUMsT0FBTyxDQUFDLEVBQUU7NEJBQ1IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7eUJBQ2pEO29CQUVMLENBQUM7aUJBQ0osQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxXQUFXLEVBQUUsVUFBUyxDQUFNO1FBQ3hCLElBQU0sS0FBSyxHQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxZQUFZLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtkZWJvdW5jZSwgTWVtb3J5LCBRdWVzdGlvbkxpc3RJdGVtfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiO1xyXG5cclxuY29uc3QgYXBwID0gZ2V0QXBwPElBcHBPcHRpb24+KCk7XHJcblBhZ2Uoe1xyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGlzSW1wb3J0OiBmYWxzZSxcclxuICAgICAgICAvLyB1cGRhdGU6IDxPYmplY3QgfCBmYWxzZT5mYWxzZSxcclxuICAgICAgICBpc1VwZGF0ZTogZmFsc2UsXHJcbiAgICAgICAgcXVlc3Rpb25MaXN0OiA8UXVlc3Rpb25MaXN0SXRlbVtdPlt7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uOiBcIlwiLFxyXG4gICAgICAgICAgICBhbnN3ZXI6IFwiXCIsXHJcbiAgICAgICAgICAgIGRlc2M6IFwiXCIsXHJcbiAgICAgICAgfV0sXHJcbiAgICAgICAgdGl0bGU6IFwiXCIsXHJcbiAgICAgICAgZGVzYzogXCJcIixcclxuICAgICAgICBtZW1vcnlPYmpTdHI6IFwiXCIsXHJcbiAgICB9LFxyXG4gICAgLy8g5L2/55So5Y6fc2V0RGF0YeS4jeS8muS/neWtmOaVsOaNrlxyXG4gICAgc2V0U3RhdGU6IDxhbnk+KCgpID0+IDApLFxyXG4gICAgb25Mb2FkOiBmdW5jdGlvbihvcHRpb25zKSB7XHJcbiAgICAgICAgY29uc3Qgc2QgPSB0aGlzLnNldERhdGE7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSA9IHNkO1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSA9ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVUZW1wTWVtb3J5KCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2V0RGF0YS4uLlwiKTtcclxuICAgICAgICAgICAgc2QuYXBwbHkodGhpcywgYXJncyBhcyBhbnkpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOWIpOaWreaYr+WQpue8lui+keeKtuaAgVxyXG4gICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7XHJcbiAgICAgICAgaWYgKHR5cGUgIT09IFwidXBkYXRlXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRUZW1wTWVtb3J5KCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOaUueagh+mimOS4uue8lui+kVxyXG4gICAgICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7dGl0bGU6IFwi57yW6L6RXCJ9KTtcclxuXHJcbiAgICAgICAgY29uc3QgbWVtb3J5OiBNZW1vcnlbXSA9IHd4LmdldFN0b3JhZ2VTeW5jKFwibWVtb3J5XCIpIHx8IFtdO1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gYXBwLmdsb2JhbERhdGEuY3VycmVudE1lbW9yeUluZGV4O1xyXG5cclxuICAgICAgICBsZXQge3F1ZXN0aW9uTGlzdCwgdGl0bGV9ID0gbWVtb3J5W2luZGV4XTtcclxuICAgICAgICAvLyDlpoLmnpxsZW5ndGjlpKfkuo4177yM5YiZ5YiG5om55aGr5YWF5YiwZGF0YVxyXG4gICAgICAgIGlmIChxdWVzdGlvbkxpc3QubGVuZ3RoID4gNSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwbGl0UHVzaFRvRGF0YShxdWVzdGlvbkxpc3Quc2xpY2UoNSkpO1xyXG4gICAgICAgICAgICBxdWVzdGlvbkxpc3QgPSBxdWVzdGlvbkxpc3Quc3BsaWNlKDAsIDUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZC5jYWxsKHRoaXMsIHtpc1VwZGF0ZTogdHJ1ZSwgdGl0bGU6IHRpdGxlLCBxdWVzdGlvbkxpc3R9KTtcclxuXHJcbiAgICB9LFxyXG5cclxuICAgIHNhdmVUZW1wTWVtb3J5OiAoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgZnVuY3Rpb24gc2F2ZSh0aGlzOiBhbnkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCLnvJPlrZjooajljZUuLi5cIik7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gdGhpcy5kYXRhLnRpdGxlO1xyXG4gICAgICAgICAgICBjb25zdCBxdWVzdGlvbkxpc3QgPSB0aGlzLmRhdGEucXVlc3Rpb25MaXN0O1xyXG4gICAgICAgICAgICB3eC5zZXRTdG9yYWdlKHtrZXk6IFwidGVtcE1lbW9yeVwiLCBkYXRhOiB7dGl0bGUsIHF1ZXN0aW9uTGlzdH19KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBkZWJvdW5jZShzYXZlLCA2MDApO1xyXG4gICAgfSkoKSxcclxuXHJcbiAgICAvLyDkuIDmrKHmgKfloavlhYXkvJrljaEgIOWIhuaJueWhq+WFheWIsGRhdGHnmoRxdWVzdGlvbkxpc3RcclxuICAgIHNwbGl0UHVzaFRvRGF0YTogZnVuY3Rpb24odGVtcFFMOiBRdWVzdGlvbkxpc3RJdGVtW10pIHtcclxuICAgICAgICBjb25zdCB0aW1lciA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgbGV0IHF1ZXN0aW9uTGlzdCA9IHRoaXMuZGF0YS5xdWVzdGlvbkxpc3Q7XHJcbiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHF1ZXN0aW9uTGlzdCwgdGVtcFFMLnNwbGljZSgwLCAxMCkpO1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtxdWVzdGlvbkxpc3R9KTtcclxuICAgICAgICAgICAgaWYgKCF0ZW1wUUwubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIDEwMCk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIOiOt+WPluS4tOaXtuS/neWtmOeahOaVsOaNrlxyXG4gICAgZ2V0VGVtcE1lbW9yeTogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdGVtcDogTWVtb3J5ID0gd3guZ2V0U3RvcmFnZVN5bmMoXCJ0ZW1wTWVtb3J5XCIpO1xyXG4gICAgICAgICAgICBpZiAoIXRlbXAgfHwgIXRlbXAudGl0bGUpIHJldHVybjtcclxuICAgICAgICAgICAgbGV0IHt0aXRsZSwgcXVlc3Rpb25MaXN0fSA9IHRlbXA7XHJcbiAgICAgICAgICAgIC8vIOWmguaenGxlbmd0aOWkp+S6jjXvvIzliJnliIbmibnloavlhYXliLBkYXRhXHJcbiAgICAgICAgICAgIGlmIChxdWVzdGlvbkxpc3QubGVuZ3RoID4gNSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcGxpdFB1c2hUb0RhdGEocXVlc3Rpb25MaXN0LnNsaWNlKDUpKTtcclxuICAgICAgICAgICAgICAgIHF1ZXN0aW9uTGlzdCA9IHF1ZXN0aW9uTGlzdC5zcGxpY2UoMCwgNSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7dGl0bGUsIHF1ZXN0aW9uTGlzdH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJnZXRUZW1wTWVtb3J5IGVycm9yXCIsIGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgYmluZEtleUlucHV0OiBmdW5jdGlvbihlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB7ZGV0YWlsLCB0YXJnZXR9ID0gZTtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IGRldGFpbC52YWx1ZTtcclxuICAgICAgICBjb25zdCB7aW5kZXgsIHR5cGV9ID0gdGFyZ2V0LmRhdGFzZXQ7XHJcblxyXG4gICAgICAgIGlmICgvaXRlbVxcLihcXHcrKS8udGVzdCh0eXBlKSkge1xyXG4gICAgICAgICAgICBjb25zdCBvYmo6IFF1ZXN0aW9uTGlzdEl0ZW0gPSB0aGlzLmRhdGEucXVlc3Rpb25MaXN0W2luZGV4XTtcclxuICAgICAgICAgICAgb2JqW1JlZ0V4cC4kMSBhcyBrZXlvZiBRdWVzdGlvbkxpc3RJdGVtXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgW2BxdWVzdGlvbkxpc3RbJHtpbmRleH1dYF06IG9iaixcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtbdHlwZV06IHZhbHVlfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHRoaXMuc2F2ZVRlbXBNZW1vcnkoKTtcclxuICAgIH0sXHJcbiAgICAvLyDmoKHpqozmlbDmja7mmK/lkKbmraPnoa5cclxuICAgIHZhbGlkYXRlOiBmdW5jdGlvbih0aXRsZTogc3RyaW5nLCBxdWVzdGlvbkxpc3Q6IFF1ZXN0aW9uTGlzdEl0ZW1bXSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIC8vIGNvbnN0IHt0aXRsZSwgcXVlc3Rpb25MaXN0fSA9IHRoaXMuZGF0YTtcclxuICAgICAgICBpZiAoIXRpdGxlKSB7XHJcbiAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBcIuagh+mimOS4jeiDveS4uuepuiFcIiwgZHVyYXRpb246IDMwMDB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXN0aW9uTGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gcXVlc3Rpb25MaXN0W2ldO1xyXG4gICAgICAgICAgICBpZiAoIWl0ZW0ucXVlc3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBg6Zeu6aKYJHtpICsgMX3kuI3og73kuLrnqbohYCwgZHVyYXRpb246IDMwMDB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWl0ZW0uYW5zd2VyKSB7XHJcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwibm9uZVwiLCB0aXRsZTogYOetlOahiCR7aSArIDF95LiN6IO95Li656m6IWAsIGR1cmF0aW9uOiAzMDAwfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9LFxyXG4gICAgZm9ybVN1Ym1pdDogZnVuY3Rpb24oZTogYW55KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Zvcm3lj5HnlJ/kuoZzdWJtaXTkuovku7bvvIzmkLrluKbmlbDmja7kuLrvvJonLCBlLmRldGFpbC52YWx1ZSk7XHJcbiAgICAgICAgY29uc3Qge3RpdGxlLCBxdWVzdGlvbkxpc3QsIGlzVXBkYXRlfSA9IHRoaXMuZGF0YTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlKHRpdGxlLCBxdWVzdGlvbkxpc3QpKSByZXR1cm47XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IFwibWVtb3J5XCI7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lbW9yeSA9IHd4LmdldFN0b3JhZ2VTeW5jKGtleSkgfHwgW107XHJcbiAgICAgICAgICAgIGNvbnN0IG9iaiA9IHt0aXRsZSwgcXVlc3Rpb25MaXN0fTtcclxuICAgICAgICAgICAgaWYgKGlzVXBkYXRlKSB7XHJcbiAgICAgICAgICAgICAgICBtZW1vcnlbYXBwLmdsb2JhbERhdGEuY3VycmVudE1lbW9yeUluZGV4XSA9IG9iajtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG1lbW9yeS5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoa2V5LCBtZW1vcnkpO1xyXG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwic3VjY2Vzc1wiLCB0aXRsZTogYCR7aXNVcGRhdGUgPyBcIuS/ruaUuVwiIDogXCLkv53lrZhcIn3miJDlip9gfSk7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgd3gubmF2aWdhdGVCYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB3eC5zZXRTdG9yYWdlU3luYyhcInRlbXBNZW1vcnlcIiwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0sIDE1MDApO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICAvLyDph43nva5cclxuICAgIGZvcm1SZXNldDogZnVuY3Rpb24oZTogYW55KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Zvcm3lj5HnlJ/kuoZyZXNldOS6i+S7tu+8jOaQuuW4puaVsOaNruS4uu+8micsIGUuZGV0YWlsLnZhbHVlKTtcclxuICAgICAgICBjb25zdCBxdWVzdGlvbkxpc3QgPSBbe1xyXG4gICAgICAgICAgICBxdWVzdGlvbjogXCJcIixcclxuICAgICAgICAgICAgYW5zd2VyOiBcIlwiLFxyXG4gICAgICAgICAgICBkZXNjOiBcIlwiLFxyXG4gICAgICAgIH1dO1xyXG4gICAgICAgIGNvbnN0IHRpdGxlID0gXCJcIjtcclxuICAgICAgICBpZiAodGhpcy5kYXRhLmlzSW1wb3J0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBtZW1vcnlPYmpTdHI6IEpTT04uc3RyaW5naWZ5KHt0aXRsZSwgcXVlc3Rpb25MaXN0fSksXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBxdWVzdGlvbkxpc3QsXHJcbiAgICAgICAgICAgICAgICB0aXRsZSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBxdWVzdGlvbkxpc3RBZGQ6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGNvbnN0IG1sID0gdGhpcy5kYXRhLnF1ZXN0aW9uTGlzdDtcclxuICAgICAgICBtbC5wdXNoKHtcclxuICAgICAgICAgICAgcXVlc3Rpb246IFwiXCIsXHJcbiAgICAgICAgICAgIGFuc3dlcjogXCJcIixcclxuICAgICAgICAgICAgZGVzYzogXCJcIixcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBxdWVzdGlvbkxpc3Q6IG1sLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHF1ZXN0aW9uTGlzdERlbGV0ZTogZnVuY3Rpb24oZTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qge2luZGV4fSA9IGUudGFyZ2V0LmRhdGFzZXQ7XHJcbiAgICAgICAgY29uc29sZS5sb2coaW5kZXgpO1xyXG5cclxuICAgICAgICBjb25zdCBtbCA9IHRoaXMuZGF0YS5xdWVzdGlvbkxpc3Q7XHJcbiAgICAgICAgbWwuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBxdWVzdGlvbkxpc3Q6IG1sLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIC8vIOeCueWHu+e8lui+kVxyXG4gICAgbWVtb3J5SW1wb3J0OiBmdW5jdGlvbigpIHtcclxuICAgICAgICBjb25zdCB7dGl0bGUsIHF1ZXN0aW9uTGlzdH0gPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtpc0ltcG9ydDogdHJ1ZSwgbWVtb3J5T2JqU3RyOiBKU09OLnN0cmluZ2lmeSh7dGl0bGUsIHF1ZXN0aW9uTGlzdH0pfSk7XHJcbiAgICB9LFxyXG4gICAgbWVtb3J5RXhwb3J0OiBmdW5jdGlvbigpIHtcclxuICAgICAgICBjb25zdCB7dGl0bGUsIHF1ZXN0aW9uTGlzdH0gPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgY29uc3QgZnNtID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBgJHt3eC5lbnYuVVNFUl9EQVRBX1BBVEh9LyR7dGl0bGV9Lmpzb25gO1xyXG4gICAgICAgIC8vIOS/neWtmOaWh+aho1xyXG4gICAgICAgIGZzbS53cml0ZUZpbGUoe1xyXG4gICAgICAgICAgICBmaWxlUGF0aCxcclxuICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoe3RpdGxlLCBxdWVzdGlvbkxpc3R9KSxcclxuICAgICAgICAgICAgZW5jb2Rpbmc6IFwidXRmLThcIixcclxuICAgICAgICAgICAgc3VjY2VzcygpIHtcclxuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBcIuS/neWtmOaIkOWKn1wifSk7XHJcbiAgICAgICAgICAgICAgICAvLyDmiZPlvIDmlofmoaNcclxuICAgICAgICAgICAgICAgIHd4Lm9wZW5Eb2N1bWVudCh7ZmlsZVBhdGg6IGZpbGVQYXRofSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhaWwocmVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xyXG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtpY29uOiBcIm5vbmVcIiwgdGl0bGU6IFwi5L+d5a2Y5aSx6LSlXCJ9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgYmFjazogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtpc0ltcG9ydDogZmFsc2V9KTtcclxuICAgIH0sXHJcbiAgICAvLyDmlofku7blr7zlhaXpobXnmoTnoa7lrprmjInpkq5cclxuICAgIGNvbmZpcm06IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGxldCB7bWVtb3J5T2JqU3RyfSA9IHRoaXMuZGF0YTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBvYmo6IE1lbW9yeSA9IEpTT04ucGFyc2UobWVtb3J5T2JqU3RyKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMudmFsaWRhdGUob2JqLnRpdGxlLCBvYmoucXVlc3Rpb25MaXN0KSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9iai5xdWVzdGlvbkxpc3QubGVuZ3RoID4gNSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3BsaXRQdXNoVG9EYXRhKG9iai5xdWVzdGlvbkxpc3Quc2xpY2UoNSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIG9iai5xdWVzdGlvbkxpc3QgPSBvYmoucXVlc3Rpb25MaXN0LnNwbGljZSgwLCA1KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7aXNJbXBvcnQ6IGZhbHNlLCAuLi5vYmp9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtpY29uOiBcIm5vbmVcIiwgdGl0bGU6IFwiMTExMTExMVwifSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH0sXHJcbiAgICBmaWxlSW1wb3J0OiBmdW5jdGlvbigpIHtcclxuICAgICAgICAvLyDpgInmi6nmlofku7ZcclxuICAgICAgICB3eC5jaG9vc2VNZXNzYWdlRmlsZSh7XHJcbiAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICB0eXBlOiBcImZpbGVcIixcclxuICAgICAgICAgICAgZXh0ZW5zaW9uOiBbXCJqc29uXCIsIFwidHh0XCJdLFxyXG4gICAgICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMudGVtcEZpbGVzWzBdKTtcclxuICAgICAgICAgICAgICAgIC8vIOivu+WPluaWh+S7tlxyXG4gICAgICAgICAgICAgICAgd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKS5yZWFkRmlsZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGg6IHJlcy50ZW1wRmlsZXNbMF0ucGF0aCxcclxuICAgICAgICAgICAgICAgICAgICBlbmNvZGluZzogXCJ1dGYtOFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZS5kYXRhIGFzIHN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCLor7vlj5bliLDmlofku7bvvJpcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9iajogTWVtb3J5ID0gSlNPTi5wYXJzZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlIHx8ICF0aGlzLnZhbGlkYXRlKG9iai50aXRsZSwgb2JqLnF1ZXN0aW9uTGlzdCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwibm9uZVwiLCB0aXRsZTogXCLmlofku7bmoLzlvI/kuI3mraPnoa5cIn0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7bWVtb3J5T2JqU3RyOiB2YWx1ZX0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwibm9uZVwiLCB0aXRsZTogXCLmlofku7bmoLzlvI/kuI3lr7lcIn0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBvbklucHV0RWRpdDogZnVuY3Rpb24oZTogYW55KSB7XHJcbiAgICAgICAgY29uc3QgdmFsdWU6IHN0cmluZyA9IGUuZGV0YWlsLnZhbHVlO1xyXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe21lbW9yeU9ialN0cjogdmFsdWV9KTtcclxuICAgIH0sXHJcbn0pO1xyXG4iXX0=