"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("../../../utils/util");
var app = getApp();
Page({
    data: {
        isImport: false,
        isUpdate: false,
        questionList: [{
                question: "",
                answer: "",
                desc: "",
            }],
        title: "",
        desc: "",
        memoryObjStr: "",
    },
    setState: (function () { return 0; }),
    onLoad: function (options) {
        var _this = this;
        var sd = this.setData;
        this.setState = sd;
        this.setData = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            _this.saveTempMemory();
            console.log("setData...");
            sd.apply(_this, args);
        };
        var type = options.type;
        if (type !== "update") {
            this.getTempMemory();
            return;
        }
        wx.setNavigationBarTitle({ title: "编辑" });
        var memory = wx.getStorageSync("memory") || [];
        var index = app.globalData.currentMemoryIndex;
        var questionList = memory[index].questionList;
        if (questionList.length > 5) {
            this.splitPushToData(questionList.slice(5));
            questionList = questionList.splice(0, 5);
        }
        sd.call(this, __assign({ isUpdate: true }, memory[index], { questionList: questionList }));
    },
    saveTempMemory: (function () {
        function save() {
            console.log("缓存表单...");
            var title = this.data.title;
            var questionList = this.data.questionList;
            wx.setStorage({ key: "tempMemory", data: { title: title, questionList: questionList } });
        }
        return util_1.debounce(save, 600);
    })(),
    splitPushToData: function (tempQL) {
        var _this = this;
        var timer = setInterval(function () {
            var questionList = _this.data.questionList;
            Array.prototype.push.apply(questionList, tempQL.splice(0, 10));
            _this.setState({ questionList: questionList });
            if (!tempQL.length) {
                clearInterval(timer);
            }
        }, 100);
    },
    getTempMemory: function () {
        try {
            var temp = wx.getStorageSync("tempMemory");
            if (!temp || !temp.title)
                return;
            var title = temp.title, questionList = temp.questionList;
            if (questionList.length > 5) {
                this.splitPushToData(questionList.slice(5));
                questionList = questionList.splice(0, 5);
            }
            this.setState({ title: title, questionList: questionList });
        }
        catch (e) {
            console.log("getTempMemory error", e);
        }
    },
    bindKeyInput: function (e) {
        var _a, _b;
        var detail = e.detail, target = e.target;
        var value = detail.value;
        var _c = target.dataset, index = _c.index, type = _c.type;
        if (/item\.(\w+)/.test(type)) {
            var obj = this.data.questionList[index];
            obj[RegExp.$1] = value;
            this.setData((_a = {},
                _a["questionList[" + index + "]"] = obj,
                _a));
        }
        else {
            this.setData((_b = {}, _b[type] = value, _b));
        }
    },
    validate: function (title, questionList) {
        if (!title) {
            wx.showToast({ icon: "none", title: "标题不能为空!", duration: 3000 });
            return false;
        }
        for (var i = 0; i < questionList.length; i++) {
            var item = questionList[i];
            if (!item.question) {
                wx.showToast({ icon: "none", title: "\u95EE\u9898" + (i + 1) + "\u4E0D\u80FD\u4E3A\u7A7A!", duration: 3000 });
                return false;
            }
            if (!item.answer) {
                wx.showToast({ icon: "none", title: "\u7B54\u6848" + (i + 1) + "\u4E0D\u80FD\u4E3A\u7A7A!", duration: 3000 });
                return false;
            }
        }
        return true;
    },
    formSubmit: function (e) {
        console.log('form发生了submit事件，携带数据为：', e.detail.value);
        var _a = this.data, title = _a.title, questionList = _a.questionList, isUpdate = _a.isUpdate, desc = _a.desc;
        if (!this.validate(title, questionList))
            return;
        try {
            var key = "memory";
            var memoryList = wx.getStorageSync(key) || [];
            var now = util_1.formatTime(new Date());
            var obj = {
                title: title,
                desc: desc,
                createTime: now,
                questionList: questionList,
                updateTime: now,
                uuid: util_1.getUUID(8),
            };
            if (isUpdate) {
                var index = app.globalData.currentMemoryIndex;
                var oldObj = memoryList[index];
                obj.createTime = oldObj.createTime;
                obj.uuid = oldObj.uuid;
                memoryList[index] = obj;
            }
            else {
                obj.updateTime = "";
                memoryList.push(obj);
            }
            wx.setStorageSync(key, memoryList);
            wx.showToast({ icon: "success", title: (isUpdate ? "修改" : "保存") + "\u6210\u529F" });
            setTimeout(function () {
                wx.navigateBack();
                wx.setStorageSync("tempMemory", null);
            }, 1500);
        }
        catch (e) {
        }
    },
    formReset: function (e) {
        console.log('form发生了reset事件，携带数据为：', e.detail.value);
        var questionList = [{
                question: "",
                answer: "",
                desc: "",
            }];
        var title = "";
        if (this.data.isImport) {
            this.setData({
                memoryObjStr: JSON.stringify({ title: title, questionList: questionList }),
            });
        }
        else {
            this.setData({
                questionList: questionList,
                title: title,
            });
        }
    },
    questionListAdd: function () {
        var ml = this.data.questionList;
        ml.push({
            question: "",
            answer: "",
            desc: "",
        });
        this.setData({
            questionList: ml,
        });
    },
    questionListDelete: function (e) {
        var index = e.target.dataset.index;
        console.log(index);
        var ml = this.data.questionList;
        ml.splice(index, 1);
        this.setData({
            questionList: ml,
        });
    },
    memoryImport: function () {
        var _a = this.data, title = _a.title, questionList = _a.questionList;
        this.setData({ isImport: true, memoryObjStr: JSON.stringify({ title: title, questionList: questionList }) });
    },
    memoryExport: function () {
        var _a = this.data, title = _a.title, questionList = _a.questionList;
        var fsm = wx.getFileSystemManager();
        var filePath = wx.env.USER_DATA_PATH + "/" + title + ".json";
        fsm.writeFile({
            filePath: filePath,
            data: JSON.stringify({ title: title, questionList: questionList }),
            encoding: "utf-8",
            success: function () {
                wx.showToast({ icon: "none", title: "保存成功" });
                wx.openDocument({ filePath: filePath });
            },
            fail: function (res) {
                console.log(res);
                wx.showToast({ icon: "none", title: "保存失败" });
            },
        });
    },
    back: function () {
        this.setData({ isImport: false });
    },
    confirm: function () {
        var memoryObjStr = this.data.memoryObjStr;
        try {
            var obj = JSON.parse(memoryObjStr);
            if (this.validate(obj.title, obj.questionList)) {
                if (obj.questionList.length > 5) {
                    this.splitPushToData(obj.questionList.slice(5));
                    obj.questionList = obj.questionList.splice(0, 5);
                }
                this.setData(__assign({ isImport: false }, obj));
            }
        }
        catch (e) {
            wx.showToast({ icon: "none", title: "1111111" });
        }
    },
    fileImport: function () {
        var _this = this;
        wx.chooseMessageFile({
            count: 1,
            type: "file",
            extension: ["json", "txt"],
            success: function (res) {
                console.log(res.tempFiles[0]);
                wx.getFileSystemManager().readFile({
                    filePath: res.tempFiles[0].path,
                    encoding: "utf-8",
                    success: function (e) {
                        var value = e.data;
                        console.log("读取到文件：");
                        console.log(value);
                        try {
                            var obj = JSON.parse(value);
                            if (!value || !_this.validate(obj.title, obj.questionList)) {
                                wx.showToast({ icon: "none", title: "文件格式不正确" });
                                return;
                            }
                            _this.setData({ memoryObjStr: value });
                        }
                        catch (e) {
                            wx.showToast({ icon: "none", title: "文件格式不对" });
                        }
                    },
                });
            },
        });
    },
    onInputEdit: function (e) {
        var value = e.detail.value;
        this.setState({ memoryObjStr: value });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSw0Q0FBNEY7QUFFNUYsSUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFjLENBQUM7QUFDakMsSUFBSSxDQUFDO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsUUFBUSxFQUFFLEtBQUs7UUFFZixRQUFRLEVBQUUsS0FBSztRQUNmLFlBQVksRUFBc0IsQ0FBQztnQkFDL0IsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLEVBQUU7YUFDWCxDQUFDO1FBQ0YsS0FBSyxFQUFFLEVBQUU7UUFDVCxJQUFJLEVBQUUsRUFBRTtRQUNSLFlBQVksRUFBRSxFQUFFO0tBQ25CO0lBRUQsUUFBUSxFQUFPLENBQUMsY0FBTSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUM7SUFDeEIsTUFBTSxFQUFFLFVBQVMsT0FBTztRQUFoQixpQkE4QlA7UUE3QkcsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQUMsY0FBYztpQkFBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJQUFjO2dCQUFkLHlCQUFjOztZQUMxQixLQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQixFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUksRUFBRSxJQUFXLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUM7UUFHRixJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBQzFCLElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNuQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDckIsT0FBTztTQUNWO1FBR0QsRUFB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QUFHLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ25CLElBQUk7NEJBQ0EsSUFBTSxHQUFHLEdBQVcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzs0QkFDdEMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0NBQ3ZELEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDO2dDQUMvQyxPQUFPOzZCQUNWOzRCQUNELEtBQUksQ0FBQyxPQUFPLENBQUMsRUFBQyxZQUFZLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQzt5QkFDdkM7d0JBQUMsT0FBTyxDQUFDLEVBQUU7NEJBQ1IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7eUJBQ2pEO29CQUVMLENBQUM7aUJBQ0osQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxXQUFXLEVBQUUsVUFBUyxDQUFNO1FBQ3hCLElBQU0sS0FBSyxHQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxZQUFZLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtkZWJvdW5jZSwgZm9ybWF0VGltZSwgZ2V0VVVJRCwgTWVtb3J5LCBRdWVzdGlvbkxpc3RJdGVtfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiO1xyXG5cclxuY29uc3QgYXBwID0gZ2V0QXBwPElBcHBPcHRpb24+KCk7XHJcblBhZ2Uoe1xyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGlzSW1wb3J0OiBmYWxzZSxcclxuICAgICAgICAvLyB1cGRhdGU6IDxPYmplY3QgfCBmYWxzZT5mYWxzZSxcclxuICAgICAgICBpc1VwZGF0ZTogZmFsc2UsXHJcbiAgICAgICAgcXVlc3Rpb25MaXN0OiA8UXVlc3Rpb25MaXN0SXRlbVtdPlt7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uOiBcIlwiLFxyXG4gICAgICAgICAgICBhbnN3ZXI6IFwiXCIsXHJcbiAgICAgICAgICAgIGRlc2M6IFwiXCIsXHJcbiAgICAgICAgfV0sXHJcbiAgICAgICAgdGl0bGU6IFwiXCIsXHJcbiAgICAgICAgZGVzYzogXCJcIixcclxuICAgICAgICBtZW1vcnlPYmpTdHI6IFwiXCIsXHJcbiAgICB9LFxyXG4gICAgLy8g5L2/55So5Y6fc2V0RGF0YeS4jeS8muS/neWtmOaVsOaNrlxyXG4gICAgc2V0U3RhdGU6IDxhbnk+KCgpID0+IDApLFxyXG4gICAgb25Mb2FkOiBmdW5jdGlvbihvcHRpb25zKSB7XHJcbiAgICAgICAgY29uc3Qgc2QgPSB0aGlzLnNldERhdGE7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSA9IHNkO1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSA9ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVUZW1wTWVtb3J5KCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2V0RGF0YS4uLlwiKTtcclxuICAgICAgICAgICAgc2QuYXBwbHkodGhpcywgYXJncyBhcyBhbnkpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOWIpOaWreaYr+WQpue8lui+keeKtuaAgVxyXG4gICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7XHJcbiAgICAgICAgaWYgKHR5cGUgIT09IFwidXBkYXRlXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRUZW1wTWVtb3J5KCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOaUueagh+mimOS4uue8lui+kVxyXG4gICAgICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7dGl0bGU6IFwi57yW6L6RXCJ9KTtcclxuXHJcbiAgICAgICAgY29uc3QgbWVtb3J5OiBNZW1vcnlbXSA9IHd4LmdldFN0b3JhZ2VTeW5jKFwibWVtb3J5XCIpIHx8IFtdO1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gYXBwLmdsb2JhbERhdGEuY3VycmVudE1lbW9yeUluZGV4O1xyXG5cclxuICAgICAgICBsZXQge3F1ZXN0aW9uTGlzdH0gPSBtZW1vcnlbaW5kZXhdO1xyXG4gICAgICAgIC8vIOWmguaenGxlbmd0aOWkp+S6jjXvvIzliJnliIbmibnloavlhYXliLBkYXRhXHJcbiAgICAgICAgaWYgKHF1ZXN0aW9uTGlzdC5sZW5ndGggPiA1KSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3BsaXRQdXNoVG9EYXRhKHF1ZXN0aW9uTGlzdC5zbGljZSg1KSk7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uTGlzdCA9IHF1ZXN0aW9uTGlzdC5zcGxpY2UoMCwgNSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNkLmNhbGwodGhpcywge2lzVXBkYXRlOiB0cnVlLCAuLi5tZW1vcnlbaW5kZXhdLCBxdWVzdGlvbkxpc3R9KTtcclxuXHJcbiAgICB9LFxyXG5cclxuICAgIHNhdmVUZW1wTWVtb3J5OiAoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgZnVuY3Rpb24gc2F2ZSh0aGlzOiBhbnkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCLnvJPlrZjooajljZUuLi5cIik7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gdGhpcy5kYXRhLnRpdGxlO1xyXG4gICAgICAgICAgICBjb25zdCBxdWVzdGlvbkxpc3QgPSB0aGlzLmRhdGEucXVlc3Rpb25MaXN0O1xyXG4gICAgICAgICAgICB3eC5zZXRTdG9yYWdlKHtrZXk6IFwidGVtcE1lbW9yeVwiLCBkYXRhOiB7dGl0bGUsIHF1ZXN0aW9uTGlzdH19KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBkZWJvdW5jZShzYXZlLCA2MDApO1xyXG4gICAgfSkoKSxcclxuXHJcbiAgICAvLyDkuIDmrKHmgKfloavlhYXkvJrljaEgIOWIhuaJueWhq+WFheWIsGRhdGHnmoRxdWVzdGlvbkxpc3RcclxuICAgIHNwbGl0UHVzaFRvRGF0YTogZnVuY3Rpb24odGVtcFFMOiBRdWVzdGlvbkxpc3RJdGVtW10pIHtcclxuICAgICAgICBjb25zdCB0aW1lciA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgbGV0IHF1ZXN0aW9uTGlzdCA9IHRoaXMuZGF0YS5xdWVzdGlvbkxpc3Q7XHJcbiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHF1ZXN0aW9uTGlzdCwgdGVtcFFMLnNwbGljZSgwLCAxMCkpO1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtxdWVzdGlvbkxpc3R9KTtcclxuICAgICAgICAgICAgaWYgKCF0ZW1wUUwubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIDEwMCk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIOiOt+WPluS4tOaXtuS/neWtmOeahOaVsOaNrlxyXG4gICAgZ2V0VGVtcE1lbW9yeTogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdGVtcDogTWVtb3J5ID0gd3guZ2V0U3RvcmFnZVN5bmMoXCJ0ZW1wTWVtb3J5XCIpO1xyXG4gICAgICAgICAgICBpZiAoIXRlbXAgfHwgIXRlbXAudGl0bGUpIHJldHVybjtcclxuICAgICAgICAgICAgbGV0IHt0aXRsZSwgcXVlc3Rpb25MaXN0fSA9IHRlbXA7XHJcbiAgICAgICAgICAgIC8vIOWmguaenGxlbmd0aOWkp+S6jjXvvIzliJnliIbmibnloavlhYXliLBkYXRhXHJcbiAgICAgICAgICAgIGlmIChxdWVzdGlvbkxpc3QubGVuZ3RoID4gNSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcGxpdFB1c2hUb0RhdGEocXVlc3Rpb25MaXN0LnNsaWNlKDUpKTtcclxuICAgICAgICAgICAgICAgIHF1ZXN0aW9uTGlzdCA9IHF1ZXN0aW9uTGlzdC5zcGxpY2UoMCwgNSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7dGl0bGUsIHF1ZXN0aW9uTGlzdH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJnZXRUZW1wTWVtb3J5IGVycm9yXCIsIGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgYmluZEtleUlucHV0OiBmdW5jdGlvbihlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB7ZGV0YWlsLCB0YXJnZXR9ID0gZTtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IGRldGFpbC52YWx1ZTtcclxuICAgICAgICBjb25zdCB7aW5kZXgsIHR5cGV9ID0gdGFyZ2V0LmRhdGFzZXQ7XHJcblxyXG4gICAgICAgIGlmICgvaXRlbVxcLihcXHcrKS8udGVzdCh0eXBlKSkge1xyXG4gICAgICAgICAgICBjb25zdCBvYmo6IFF1ZXN0aW9uTGlzdEl0ZW0gPSB0aGlzLmRhdGEucXVlc3Rpb25MaXN0W2luZGV4XTtcclxuICAgICAgICAgICAgb2JqW1JlZ0V4cC4kMSBhcyBrZXlvZiBRdWVzdGlvbkxpc3RJdGVtXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgW2BxdWVzdGlvbkxpc3RbJHtpbmRleH1dYF06IG9iaixcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtbdHlwZV06IHZhbHVlfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHRoaXMuc2F2ZVRlbXBNZW1vcnkoKTtcclxuICAgIH0sXHJcbiAgICAvLyDmoKHpqozmlbDmja7mmK/lkKbmraPnoa5cclxuICAgIHZhbGlkYXRlOiBmdW5jdGlvbih0aXRsZTogc3RyaW5nLCBxdWVzdGlvbkxpc3Q6IFF1ZXN0aW9uTGlzdEl0ZW1bXSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIC8vIGNvbnN0IHt0aXRsZSwgcXVlc3Rpb25MaXN0fSA9IHRoaXMuZGF0YTtcclxuICAgICAgICBpZiAoIXRpdGxlKSB7XHJcbiAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBcIuagh+mimOS4jeiDveS4uuepuiFcIiwgZHVyYXRpb246IDMwMDB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXN0aW9uTGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gcXVlc3Rpb25MaXN0W2ldO1xyXG4gICAgICAgICAgICBpZiAoIWl0ZW0ucXVlc3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBg6Zeu6aKYJHtpICsgMX3kuI3og73kuLrnqbohYCwgZHVyYXRpb246IDMwMDB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWl0ZW0uYW5zd2VyKSB7XHJcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwibm9uZVwiLCB0aXRsZTogYOetlOahiCR7aSArIDF95LiN6IO95Li656m6IWAsIGR1cmF0aW9uOiAzMDAwfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9LFxyXG4gICAgZm9ybVN1Ym1pdDogZnVuY3Rpb24oZTogYW55KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Zvcm3lj5HnlJ/kuoZzdWJtaXTkuovku7bvvIzmkLrluKbmlbDmja7kuLrvvJonLCBlLmRldGFpbC52YWx1ZSk7XHJcbiAgICAgICAgY29uc3Qge3RpdGxlLCBxdWVzdGlvbkxpc3QsIGlzVXBkYXRlLCBkZXNjfSA9IHRoaXMuZGF0YTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlKHRpdGxlLCBxdWVzdGlvbkxpc3QpKSByZXR1cm47XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IFwibWVtb3J5XCI7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lbW9yeUxpc3Q6IE1lbW9yeVtdID0gd3guZ2V0U3RvcmFnZVN5bmMoa2V5KSB8fCBbXTtcclxuICAgICAgICAgICAgY29uc3Qgbm93ID0gZm9ybWF0VGltZShuZXcgRGF0ZSgpKTtcclxuICAgICAgICAgICAgY29uc3Qgb2JqOiBNZW1vcnkgPSB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZSxcclxuICAgICAgICAgICAgICAgIGRlc2MsXHJcbiAgICAgICAgICAgICAgICBjcmVhdGVUaW1lOiBub3csXHJcbiAgICAgICAgICAgICAgICBxdWVzdGlvbkxpc3QsXHJcbiAgICAgICAgICAgICAgICB1cGRhdGVUaW1lOiBub3csXHJcbiAgICAgICAgICAgICAgICB1dWlkOiBnZXRVVUlEKDgpLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAoaXNVcGRhdGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gYXBwLmdsb2JhbERhdGEuY3VycmVudE1lbW9yeUluZGV4O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2xkT2JqID0gbWVtb3J5TGlzdFtpbmRleF07XHJcbiAgICAgICAgICAgICAgICBvYmouY3JlYXRlVGltZSA9IG9sZE9iai5jcmVhdGVUaW1lO1xyXG4gICAgICAgICAgICAgICAgb2JqLnV1aWQgPSBvbGRPYmoudXVpZDtcclxuICAgICAgICAgICAgICAgIG1lbW9yeUxpc3RbaW5kZXhdID0gb2JqO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgb2JqLnVwZGF0ZVRpbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgbWVtb3J5TGlzdC5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoa2V5LCBtZW1vcnlMaXN0KTtcclxuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtpY29uOiBcInN1Y2Nlc3NcIiwgdGl0bGU6IGAke2lzVXBkYXRlID8gXCLkv67mlLlcIiA6IFwi5L+d5a2YXCJ95oiQ5YqfYH0pO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHd4Lm5hdmlnYXRlQmFjaygpO1xyXG4gICAgICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoXCJ0ZW1wTWVtb3J5XCIsIG51bGwpO1xyXG4gICAgICAgICAgICB9LCAxNTAwKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcblxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLy8g6YeN572uXHJcbiAgICBmb3JtUmVzZXQ6IGZ1bmN0aW9uKGU6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdmb3Jt5Y+R55Sf5LqGcmVzZXTkuovku7bvvIzmkLrluKbmlbDmja7kuLrvvJonLCBlLmRldGFpbC52YWx1ZSk7XHJcbiAgICAgICAgY29uc3QgcXVlc3Rpb25MaXN0ID0gW3tcclxuICAgICAgICAgICAgcXVlc3Rpb246IFwiXCIsXHJcbiAgICAgICAgICAgIGFuc3dlcjogXCJcIixcclxuICAgICAgICAgICAgZGVzYzogXCJcIixcclxuICAgICAgICB9XTtcclxuICAgICAgICBjb25zdCB0aXRsZSA9IFwiXCI7XHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YS5pc0ltcG9ydCkge1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgbWVtb3J5T2JqU3RyOiBKU09OLnN0cmluZ2lmeSh7dGl0bGUsIHF1ZXN0aW9uTGlzdH0pLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgcXVlc3Rpb25MaXN0LFxyXG4gICAgICAgICAgICAgICAgdGl0bGUsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgcXVlc3Rpb25MaXN0QWRkOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBjb25zdCBtbCA9IHRoaXMuZGF0YS5xdWVzdGlvbkxpc3Q7XHJcbiAgICAgICAgbWwucHVzaCh7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uOiBcIlwiLFxyXG4gICAgICAgICAgICBhbnN3ZXI6IFwiXCIsXHJcbiAgICAgICAgICAgIGRlc2M6IFwiXCIsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgcXVlc3Rpb25MaXN0OiBtbCxcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBxdWVzdGlvbkxpc3REZWxldGU6IGZ1bmN0aW9uKGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHtpbmRleH0gPSBlLnRhcmdldC5kYXRhc2V0O1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGluZGV4KTtcclxuXHJcbiAgICAgICAgY29uc3QgbWwgPSB0aGlzLmRhdGEucXVlc3Rpb25MaXN0O1xyXG4gICAgICAgIG1sLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgcXVlc3Rpb25MaXN0OiBtbCxcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcbiAgICAvLyDngrnlh7vnvJbovpFcclxuICAgIG1lbW9yeUltcG9ydDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY29uc3Qge3RpdGxlLCBxdWVzdGlvbkxpc3R9ID0gdGhpcy5kYXRhO1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7aXNJbXBvcnQ6IHRydWUsIG1lbW9yeU9ialN0cjogSlNPTi5zdHJpbmdpZnkoe3RpdGxlLCBxdWVzdGlvbkxpc3R9KX0pO1xyXG4gICAgfSxcclxuICAgIG1lbW9yeUV4cG9ydDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY29uc3Qge3RpdGxlLCBxdWVzdGlvbkxpc3R9ID0gdGhpcy5kYXRhO1xyXG4gICAgICAgIGNvbnN0IGZzbSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7d3guZW52LlVTRVJfREFUQV9QQVRIfS8ke3RpdGxlfS5qc29uYDtcclxuICAgICAgICAvLyDkv53lrZjmlofmoaNcclxuICAgICAgICBmc20ud3JpdGVGaWxlKHtcclxuICAgICAgICAgICAgZmlsZVBhdGgsXHJcbiAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHt0aXRsZSwgcXVlc3Rpb25MaXN0fSksXHJcbiAgICAgICAgICAgIGVuY29kaW5nOiBcInV0Zi04XCIsXHJcbiAgICAgICAgICAgIHN1Y2Nlc3MoKSB7XHJcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe2ljb246IFwibm9uZVwiLCB0aXRsZTogXCLkv53lrZjmiJDlip9cIn0pO1xyXG4gICAgICAgICAgICAgICAgLy8g5omT5byA5paH5qGjXHJcbiAgICAgICAgICAgICAgICB3eC5vcGVuRG9jdW1lbnQoe2ZpbGVQYXRoOiBmaWxlUGF0aH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBmYWlsKHJlcykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzKTtcclxuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBcIuS/neWtmOWksei0pVwifSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGJhY2s6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7aXNJbXBvcnQ6IGZhbHNlfSk7XHJcbiAgICB9LFxyXG4gICAgLy8g5paH5Lu25a+85YWl6aG155qE56Gu5a6a5oyJ6ZKuXHJcbiAgICBjb25maXJtOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBsZXQge21lbW9yeU9ialN0cn0gPSB0aGlzLmRhdGE7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3Qgb2JqOiBNZW1vcnkgPSBKU09OLnBhcnNlKG1lbW9yeU9ialN0cik7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnZhbGlkYXRlKG9iai50aXRsZSwgb2JqLnF1ZXN0aW9uTGlzdCkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvYmoucXVlc3Rpb25MaXN0Lmxlbmd0aCA+IDUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwbGl0UHVzaFRvRGF0YShvYmoucXVlc3Rpb25MaXN0LnNsaWNlKDUpKTtcclxuICAgICAgICAgICAgICAgICAgICBvYmoucXVlc3Rpb25MaXN0ID0gb2JqLnF1ZXN0aW9uTGlzdC5zcGxpY2UoMCwgNSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe2lzSW1wb3J0OiBmYWxzZSwgLi4ub2JqfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7aWNvbjogXCJub25lXCIsIHRpdGxlOiBcIjExMTExMTFcIn0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9LFxyXG4gICAgZmlsZUltcG9ydDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgLy8g6YCJ5oup5paH5Lu2XHJcbiAgICAgICAgd3guY2hvb3NlTWVzc2FnZUZpbGUoe1xyXG4gICAgICAgICAgICBjb3VudDogMSxcclxuICAgICAgICAgICAgdHlwZTogXCJmaWxlXCIsXHJcbiAgICAgICAgICAgIGV4dGVuc2lvbjogW1wianNvblwiLCBcInR4dFwiXSxcclxuICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzLnRlbXBGaWxlc1swXSk7XHJcbiAgICAgICAgICAgICAgICAvLyDor7vlj5bmlofku7ZcclxuICAgICAgICAgICAgICAgIHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKCkucmVhZEZpbGUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoOiByZXMudGVtcEZpbGVzWzBdLnBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgZW5jb2Rpbmc6IFwidXRmLThcIixcclxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGUuZGF0YSBhcyBzdHJpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi6K+75Y+W5Yiw5paH5Lu277yaXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmo6IE1lbW9yeSA9IEpTT04ucGFyc2UodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSB8fCAhdGhpcy52YWxpZGF0ZShvYmoudGl0bGUsIG9iai5xdWVzdGlvbkxpc3QpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtpY29uOiBcIm5vbmVcIiwgdGl0bGU6IFwi5paH5Lu25qC85byP5LiN5q2j56GuXCJ9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe21lbW9yeU9ialN0cjogdmFsdWV9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtpY29uOiBcIm5vbmVcIiwgdGl0bGU6IFwi5paH5Lu25qC85byP5LiN5a+5XCJ9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgb25JbnB1dEVkaXQ6IGZ1bmN0aW9uKGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlOiBzdHJpbmcgPSBlLmRldGFpbC52YWx1ZTtcclxuICAgICAgICB0aGlzLnNldFN0YXRlKHttZW1vcnlPYmpTdHI6IHZhbHVlfSk7XHJcbiAgICB9LFxyXG59KTtcclxuIl19